name: Gentoo Desktop OpenRC AMD64

on:
  push:
    branches: [master]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  gentoo-job:
    runs-on: ubuntu-latest  # GitHub Actions host runner
    container:
      image: gentoo/stage3:desktop  # Pulls the Gentoo image from Docker Hub
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Synchronise repo and install essentials 
        run: |
          emerge --sync
          emerge dev-vcs/git flaggie app-eselect/eselect-repository openssh sudo
      - name: Recreate git repo structure
        run: |
          git config --global user.name "Madman10K"
          git config --global user.email "contact@madladsquad.com"
          git config --global --add safe.directory "$(realpath .)"
          git init
          git branch -m master
          git remote add origin https://github.com/MadLadSquad/UntitledDesktopOverlay
          git fetch --all
          git reset --hard origin/master
      - name: Update manifests
        run: |
          useradd -K MAIL_DIR=/dev/null -m builder
          chown -R builder $(pwd)
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

          # Helper alias to run commands as builder with the correct HOME
          # We use this instead of sudo -E to prevent /github/home permission errors
          cmd_builder="sudo -u builder env HOME=/home/builder"

          $cmd_builder git config --global user.name Madman10K
          $cmd_builder git config --global user.email contact@madladsquad.com
          $cmd_builder git config --global init.defaultBranch main
          $cmd_builder git config --global commit.gpgsign true
          $cmd_builder git config --global tag.gpgsign true
          $cmd_builder git config --global gpg.format ssh
          
          $cmd_builder mkdir -p /home/builder/.ssh
          echo "${{ secrets.ACTIONS_GENTOO_SSH_KEY }}" | $cmd_builder tee /home/builder/.ssh/id_rsa > /dev/null
          $cmd_builder chmod 600 /home/builder/.ssh/id_rsa
          
          $cmd_builder git config --global user.signingkey /home/builder/.ssh/id_rsa

          # SSH-Keyscan: Explicit HOME ensures it looks in /home/builder/.ssh, not /github/home/.ssh
          $cmd_builder ssh-keyscan -H github.com | $cmd_builder tee -a /home/builder/.ssh/known_hosts > /dev/null
          
          # --- FIXED SSH AGENT SETUP ---
          # 1. Define a fixed socket path that both steps can access
          SOCKET="/tmp/ssh_agent.sock"
          
          # 2. Start the agent in the background bound to this socket
          $cmd_builder ssh-agent -a "$SOCKET" > /dev/null
          
          # 3. Add the key to the agent using the specific socket
          $cmd_builder env SSH_AUTH_SOCK="$SOCKET" ssh-add /home/builder/.ssh/id_rsa
          
          $cmd_builder git fetch --all
          old="$(pwd)"
          for manifest in $(find -iname "Manifest"); do
            man="$(realpath "${manifest}")"
            cd "$(dirname "${man}")"
            rm Manifest
            # This runs as root (standard for ebuild), which is fine
            ebuild *.ebuild clean digest
            cd "${old}"
          done
          
          # Reset ownership to builder so git can access the changed files
          chown -R builder $(pwd)
          
          $cmd_builder git remote set-url origin git@github.com:MadLadSquad/UntitledDesktopOverlay
          
          # --- GIT PUSH WITH AGENT ---
          # Pass the SOCKET variable so git can find the agent we started earlier
          $cmd_builder env SSH_AUTH_SOCK="$SOCKET" sh -c "(git add . && git commit -m 'Update manifest' && git push origin HEAD:master) || echo 'Nothing to commit'"
      - name: Sync and add repo   
        run: |
          eselect repository add untitled-desktop-overlay git https://github.com/MadLadSquad/UntitledDesktopOverlay.git || exit
          emerge --sync untitled-desktop-overlay || exit
      - name: Configure use flags
        run: |
          flaggie raft +lz4
          flaggie xdelta +lzma
          flaggie squashfs-tools +lzma
          flaggie libcap +static-libs
      - name: Install applications
        run: |
          emerge untitled-ibus-handwriting untitled-game-system-manager ude-session-logout || exit
        
    
